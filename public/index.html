<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wrath Shadow Priest Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .icon-alert::before { content: "‚ö†Ô∏è"; }
        .icon-search::before { content: "üîç"; }
        .icon-loader::before { content: "‚è≥"; }
        .icon-chart::before { content: "üìä"; }
        .icon-arrow-left::before { content: "‚Üê"; }
        .spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .dropdown-arrow::after {
            content: "‚ñº";
            font-size: 12px;
            color: #93c5fd;
        }
    </style>
</head>
<body>
    <div id="root">
        <div class="min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 p-6">
            <div class="max-w-6xl mx-auto">
                <!-- Header -->
                <div class="text-center mb-8">
                    <div class="flex items-center justify-center gap-3 mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-green-500 rounded-lg flex items-center justify-center">
                            <span class="text-white text-xl">üë§</span>
                        </div>
                        <h1 class="text-3xl font-bold text-white">Wrath Shadow Priest Analyzer</h1>
                    </div>
                </div>

                <div class="bg-gray-800/60 backdrop-blur-md rounded-2xl p-8 shadow-2xl border border-gray-700">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <!-- Report ID Input -->
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                Enter WCL report ID or URL
                            </label>
                            <div class="relative">
                                <input
                                    type="text"
                                    id="reportInput"
                                    placeholder="H3hZVgNBtyXPRbmQ"
                                    class="w-full p-3 pr-10 rounded-lg bg-gray-700 border border-gray-600 text-white placeholder-gray-400 focus:outline-none focus:border-blue-400 focus:ring-2 focus:ring-blue-400/50"
                                />
                                <button id="loadReportBtn" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-blue-400 hover:text-blue-300">
                                    ‚úì
                                </button>
                            </div>
                        </div>

                        <!-- Player Selection -->
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                Select Player
                            </label>
                            <div class="relative">
                                <select
                                    id="playerSelect"
                                    disabled
                                    class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:border-blue-400 focus:ring-2 focus:ring-blue-400/50 disabled:opacity-50 disabled:cursor-not-allowed appearance-none dropdown-arrow"
                                >
                                    <option value="">Load report first</option>
                                </select>
                            </div>
                        </div>

                        <!-- Encounter Selection -->
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                Select Encounter
                            </label>
                            <div class="relative">
                                <select
                                    id="encounterSelect"
                                    disabled
                                    class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:border-blue-400 focus:ring-2 focus:ring-blue-400/50 disabled:opacity-50 disabled:cursor-not-allowed appearance-none dropdown-arrow"
                                >
                                    <option value="">Select player first</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <button
                        id="analyzeBtn"
                        disabled
                        class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white font-semibold py-3 px-6 rounded-lg hover:from-blue-700 hover:to-purple-700 focus:outline-none focus:ring-2 focus:ring-blue-500/50 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 flex items-center justify-center gap-2"
                    >
                        <span class="icon-search"></span>
                        Analyze Shadow Priest Performance
                    </button>

                    <!-- Error display -->
                    <div id="error" class="mt-6 bg-red-500/20 border border-red-500/50 rounded-lg p-4 hidden">
                        <div class="flex items-center gap-2 text-red-200">
                            <span class="icon-alert"></span>
                            <span class="font-medium">Error:</span>
                        </div>
                        <p class="text-red-100 mt-1" id="errorMessage"></p>
                    </div>

                    <!-- Results display -->
                    <div id="results" class="mt-8 hidden">
                        <div id="resultsContent"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Shadow Priest spells with their details
        const shadowPriestSpells = {
            34914: { name: 'Vampiric Touch', type: 'dot', gcd: 1.5 },
            2944: { name: 'Devouring Plague', type: 'dot', gcd: 1.5 },
            589: { name: 'Shadow Word: Pain', type: 'dot', gcd: 1.5 },
            8092: { name: 'Mind Blast', type: 'instant', gcd: 1.5 },
            15407: { name: 'Mind Flay', type: 'channel', gcd: 0 },
            32379: { name: 'Shadow Word: Death', type: 'instant', gcd: 1.5 },
            73510: { name: 'Mind Spike', type: 'cast', gcd: 1.5 }
        };

        // State management
        let reportData = null;
        let currentAnalysis = null;

        // Utility functions
        function extractReportId(input) {
            if (!input) return null;
            // If it's already just an ID
            if (input.length <= 20 && !input.includes('/')) {
                return input;
            }
            // Extract from URL
            const match = input.match(/reports\/([a-zA-Z0-9]+)/);
            return match ? match[1] : null;
        }

        function formatTime(ms) {
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        function formatNumber(num) {
            if (num === null || num === undefined) return '---';
            if (typeof num !== 'number') return num;
            return num.toLocaleString();
        }

        // UI Management
        function showError(message) {
            document.getElementById('error').classList.remove('hidden');
            document.getElementById('errorMessage').textContent = message;
        }

        function hideError() {
            document.getElementById('error').classList.add('hidden');
        }

        function setLoading(loading) {
            const btn = document.getElementById('analyzeBtn');
            if (loading) {
                btn.disabled = true;
                btn.innerHTML = '<span class="icon-loader spinner"></span>Analyzing...';
            } else {
                const canAnalyze = document.getElementById('playerSelect').value && 
                                 document.getElementById('encounterSelect').value;
                btn.disabled = !canAnalyze;
                btn.innerHTML = '<span class="icon-search"></span>Analyze Shadow Priest Performance';
            }
        }

        // Data Loading Functions
        async function loadReport() {
            const input = document.getElementById('reportInput').value.trim();
            const reportId = extractReportId(input);
            
            if (!reportId) {
                showError('Please enter a valid report ID or URL');
                return;
            }

            try {
                hideError();
                document.getElementById('loadReportBtn').innerHTML = '‚è≥';
                
                // Load report data (you'll need to implement this endpoint)
                const response = await fetch('/.netlify/functions/load-report-data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reportId })
                });

                if (!response.ok) {
                    throw new Error('Failed to load report');
                }

                reportData = await response.json();
                populatePlayerDropdown();
                document.getElementById('loadReportBtn').innerHTML = '‚úì';
                
            } catch (err) {
                showError(err.message);
                document.getElementById('loadReportBtn').innerHTML = '‚úì';
            }
        }

        function populatePlayerDropdown() {
            const playerSelect = document.getElementById('playerSelect');
            playerSelect.innerHTML = '<option value="">Select a Shadow Priest</option>';
            
            // Filter for Shadow Priests
            const shadowPriests = reportData.players.filter(p => 
                p.type === 'Priest' && p.specs && p.specs.includes('Shadow')
            );
            
            shadowPriests.forEach(player => {
                const option = document.createElement('option');
                option.value = player.id;
                option.textContent = player.name;
                playerSelect.appendChild(option);
            });
            
            playerSelect.disabled = shadowPriests.length === 0;
            if (shadowPriests.length === 0) {
                showError('No Shadow Priests found in this report');
            }
        }

        function populateEncounterDropdown() {
            const encounterSelect = document.getElementById('encounterSelect');
            encounterSelect.innerHTML = '<option value="">Select an encounter</option>';
            
            reportData.fights.forEach(fight => {
                if (fight.boss && fight.boss > 0) { // Only boss fights
                    const option = document.createElement('option');
                    option.value = fight.id;
                    option.textContent = `${fight.name} (${formatTime(fight.end_time - fight.start_time)})`;
                    encounterSelect.appendChild(option);
                }
            });
            
            encounterSelect.disabled = false;
            updateAnalyzeButton();
        }

        function updateAnalyzeButton() {
            const canAnalyze = document.getElementById('playerSelect').value && 
                             document.getElementById('encounterSelect').value;
            document.getElementById('analyzeBtn').disabled = !canAnalyze;
        }

        // Analysis Functions
        async function analyzePerformance() {
            const playerId = document.getElementById('playerSelect').value;
            const fightId = document.getElementById('encounterSelect').value;
            
            if (!playerId || !fightId) return;

            setLoading(true);
            hideError();

            try {
                const response = await fetch('/.netlify/functions/analyze-detailed-performance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        reportId: reportData.reportId,
                        playerId: parseInt(playerId),
                        fightId: parseInt(fightId)
                    })
                });

                if (!response.ok) {
                    throw new Error('Analysis failed');
                }

                currentAnalysis = await response.json();
                displayResults();

            } catch (err) {
                showError(err.message);
            } finally {
                setLoading(false);
            }
        }

        function calculateSpellMetrics(spellData) {
            const metrics = {
                casts: spellData.casts?.length || 0,
                damage: spellData.damage || 0,
                activeDPS: '---',
                activeTime: '0:00',
                hits: spellData.hits?.length || 0,
                avgHit: 0,
                critRate: 0,
                damagePerGCD: '---',
                avgDelay: '---',
                avgDotDowntime: '---',
                clippedDots: '---',
                avgSpellpower: spellData.avgSpellpower || '---',
                avgHaste: spellData.avgHaste || '---',
                gcdUsage: 0
            };

            if (spellData.hits && spellData.hits.length > 0) {
                metrics.avgHit = Math.round(spellData.damage / spellData.hits.length);
                const crits = spellData.hits.filter(hit => hit.hitType === 2).length;
                metrics.critRate = Math.round((crits / spellData.hits.length) * 100);
            }

            if (spellData.activeTime > 0) {
                metrics.activeDPS = Math.round(spellData.damage / (spellData.activeTime / 1000));
                metrics.activeTime = formatTime(spellData.activeTime);
            }

            return metrics;
        }

        function displayResults() {
            const player = reportData.players.find(p => p.id == document.getElementById('playerSelect').value);
            const fight = reportData.fights.find(f => f.id == document.getElementById('encounterSelect').value);
            
            let resultsHtml = `
                <div class="bg-gray-800/40 rounded-xl p-6 border border-gray-700">
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold text-white mb-2">Shadow Priest Analysis</h2>
                        <div class="text-gray-300 space-y-1">
                            <p><strong>Player:</strong> ${player.name}</p>
                            <p><strong>Fight:</strong> ${fight.name}</p>
                            <p><strong>Duration:</strong> ${formatTime(fight.end_time - fight.start_time)}</p>
                        </div>
                    </div>

                    <div class="space-y-6">
            `;

            Object.entries(shadowPriestSpells).forEach(([spellId, spellInfo]) => {
                const spellData = currentAnalysis.spells[spellId] || {};
                const metrics = calculateSpellMetrics(spellData);
                
                resultsHtml += `
                    <div class="bg-gray-900/50 rounded-lg p-4 border border-gray-600">
                        <h3 class="text-lg font-semibold text-white mb-4">${spellInfo.name}</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 text-sm">
                            <div class="bg-gray-800 rounded p-3">
                                <div class="text-gray-400">Casts</div>
                                <div class="text-white font-semibold">${formatNumber(metrics.casts)}</div>
                            </div>
                            <div class="bg-gray-800 rounded p-3">
                                <div class="text-gray-400">Damage</div>
                                <div class="text-white font-semibold">${formatNumber(metrics.damage)}</div>
                            </div>
                            <div class="bg-gray-800 rounded p-3">
                                <div class="text-gray-400">Active DPS</div>
                                <div class="text-white font-semibold">${formatNumber(metrics.activeDPS)}</div>
                            </div>
                            <div class="bg-gray-800 rounded p-3">
                                <div class="text-gray-400">Active Time</div>
                                <div class="text-white font-semibold">${metrics.activeTime}</div>
                            </div>
                            <div class="bg-gray-800 rounded p-3">
                                <div class="text-gray-400">Hits</div>
                                <div class="text-white font-semibold">${formatNumber(metrics.hits)}</div>
                            </div>
                            <div class="bg-gray-800 rounded p-3">
                                <div class="text-gray-400">Avg Hit</div>
                                <div class="text-white font-semibold">${formatNumber(metrics.avgHit)}</div>
                            </div>
                            <div class="bg-gray-800 rounded p-3">
                                <div class="text-gray-400">Crit Rate</div>
                                <div class="text-white font-semibold">${metrics.critRate}%</div>
                            </div>
                            <div class="bg-gray-800 rounded p-3">
                                <div class="text-gray-400">Damage/GCD</div>
                                <div class="text-white font-semibold">${formatNumber(metrics.damagePerGCD)}</div>
                            </div>
                            <div class="bg-gray-800 rounded p-3">
                                <div class="text-gray-400">Avg Delay</div>
                                <div class="text-white font-semibold">${formatNumber(metrics.avgDelay)}</div>
                            </div>
                            <div class="bg-gray-800 rounded p-3">
                                <div class="text-gray-400">Avg DoT Downtime</div>
                                <div class="text-white font-semibold">${formatNumber(metrics.avgDotDowntime)}</div>
                            </div>
                            <div class="bg-gray-800 rounded p-3">
                                <div class="text-gray-400">Clipped DoTs</div>
                                <div class="text-white font-semibold">${formatNumber(metrics.clippedDots)}</div>
                            </div>
                            <div class="bg-gray-800 rounded p-3">
                                <div class="text-gray-400">Avg Spellpower</div>
                                <div class="text-white font-semibold">${formatNumber(metrics.avgSpellpower)}</div>
                            </div>
                            <div class="bg-gray-800 rounded p-3">
                                <div class="text-gray-400">Avg Haste</div>
                                <div class="text-white font-semibold">${formatNumber(metrics.avgHaste)}</div>
                            </div>
                            <div class="bg-gray-800 rounded p-3">
                                <div class="text-gray-400">GCD Usage</div>
                                <div class="text-white font-semibold">${formatNumber(metrics.gcdUsage)}</div>
                            </div>
                        </div>
                    </div>
                `;
            });

            resultsHtml += `
                    </div>
                </div>
            `;

            document.getElementById('resultsContent').innerHTML = resultsHtml;
            document.getElementById('results').classList.remove('hidden');
        }

        // Event Listeners
        document.getElementById('loadReportBtn').addEventListener('click', loadReport);
        document.getElementById('reportInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') loadReport();
        });

        document.getElementById('playerSelect').addEventListener('change', function() {
            if (this.value) {
                populateEncounterDropdown();
            } else {
                document.getElementById('encounterSelect').innerHTML = '<option value="">Select player first</option>';
                document.getElementById('encounterSelect').disabled = true;
                updateAnalyzeButton();
            }
        });

        document.getElementById('encounterSelect').addEventListener('change', updateAnalyzeButton);
        document.getElementById('analyzeBtn').addEventListener('click', analyzePerformance);

        console.log('Wrath Shadow Priest Analyzer loaded successfully!');
    </script>
</body>
</html>
